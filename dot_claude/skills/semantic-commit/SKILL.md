---
name: semantic-commit
description: 大きな変更を意味のある最小単位に分割し、セマンティックなコミットメッセージで順次コミット。コミット分割、Conventional Commits 準拠、プロジェクト規約の自動検出に対応。
disable-model-invocation: true
user-invocable: true
argument-hint: "--dry-run"
allowed-tools: Bash, Read, Grep, Glob
---

# Semantic Commit

大きな変更を意味のある最小単位に分割して、セマンティックなコミットメッセージと共に順次コミットします。外部ツールに依存せず、git 標準コマンドのみを使用します。

## 使い方

```bash
/semantic-commit [オプション]
```

### オプション

- `--dry-run` : 実際のコミットは行わず、提案されるコミット分割のみを表示

## 動作フロー

1. **変更分析**: `git diff HEAD` で全変更を取得
2. **ファイル分類**: 変更されたファイルを論理的にグループ化
3. **コミット提案**: 各グループに対してセマンティックなコミットメッセージを生成
4. **順次実行**: ユーザー確認後、各グループを順次コミット

## 変更分割の核心機能

### 「大きな変更」の検出

以下の条件で大きな変更として検出：

1. **変更ファイル数**: 5 ファイル以上の変更
2. **変更行数**: 100 行以上の変更
3. **複数機能**: 2 つ以上の機能領域にまたがる変更
4. **混在パターン**: feat + fix + docs が混在

### 分割の粒度

#### ファイル単位の分割

- 異なるファイルを論理的にグループ化
- `git add <file>` でステージング

#### 行単位（hunk単位）の分割

同一ファイル内で異なる目的の変更が混在する場合、パッチファイルを使用して行単位で分割：

```bash
# 0. 一時ディレクトリを作成
TMPDIR=$(mktemp -d)

# 1. 差分からパッチを作成
git diff HEAD -- <file> > "$TMPDIR/full.patch"

# 2. パッチを論理単位に分割編集
#    (hunk ごとに別ファイルに保存)

# 3. 特定の変更のみステージング
git apply --cached "$TMPDIR/partial.patch"

# 4. コミット
git commit -m "feat: ..."

# 5. 次のパッチをステージング
git apply --cached "$TMPDIR/another.patch"

# 6. 一時ディレクトリを削除
rm -rf "$TMPDIR"
```

**行単位分割が有効なケース:**
- 同一ファイルに bug fix と refactor が混在
- 関数追加と既存関数の修正が同居
- import 文の追加と本体の変更を分離したい場合

### 「意味のある最小単位」への分割戦略

#### 1. 機能境界による分割

ディレクトリ構造から機能単位を特定：
- `src/auth/` 配下 → 認証機能
- `components/` 配下 → UI コンポーネント

#### 2. 変更種別による分離

- 新規ファイル (A) vs 修正ファイル (M) vs 削除ファイル (D)

#### 3. 依存関係の分析

インポート関係や型定義の変更を検出し、関連ファイルをグループ化

### 論理的グループ化の基準

1. **機能単位**: 同一機能に関連するファイル
2. **変更種別**: テストファイルのみ → `test:`、ドキュメントのみ → `docs:`
3. **依存関係**: モデル + マイグレーション、コンポーネント + スタイル
4. **変更規模**: 1 コミットあたり 10 ファイル以下

## 出力例

```
変更分析中...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

検出された変更:
• src/auth/login.ts (修正)
• src/auth/register.ts (新規)
• tests/auth.test.ts (新規)

提案されるコミット分割:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
コミット 1/2
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
メッセージ: feat: implement user registration and login system
含まれるファイル:
  • src/auth/login.ts
  • src/auth/register.ts

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
コミット 2/2
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
メッセージ: test: add comprehensive tests for authentication system
含まれるファイル:
  • tests/auth.test.ts

この分割案でコミットを実行しますか？ (y/n/edit):
```

## 実行時の選択肢

- `y` : 提案されたコミット分割で実行
- `n` : キャンセル
- `edit` : コミットメッセージを個別に編集
- `merge <番号1> <番号2>` : 指定したコミットをマージ
- `split <番号>` : 指定したコミットをさらに分割

## Conventional Commits 準拠

### 基本形式

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

### 標準タイプ

**必須タイプ**:
- `feat`: 新機能 (ユーザーに見える機能追加)
- `fix`: バグ修正

**任意タイプ**:
- `build`: ビルドシステムや外部依存関係の変更
- `chore`: その他の変更 (リリースに影響しない)
- `ci`: CI 設定ファイルやスクリプトの変更
- `docs`: ドキュメントのみの変更
- `style`: コードの意味に影響しない変更 (フォーマット等)
- `refactor`: バグ修正や機能追加を伴わないコード変更
- `perf`: パフォーマンス改善
- `test`: テストの追加や修正

### スコープ (任意)

変更の影響範囲を示す：
```
feat(api): add user authentication endpoint
fix(ui): resolve button alignment issue
```

### Breaking Change

```
feat!: change user API response format

BREAKING CHANGE: user response now includes additional metadata
```

## プロジェクト規約の自動検出

以下のファイルから設定を自動検出：

- `commitlint.config.js` / `.mjs` / `.cjs` / `.ts`
- `.commitlintrc.js` / `.json` / `.yml` / `.yaml`
- `package.json` の `commitlint` セクション

カスタムタイプ、スコープ制限、メッセージ長制限などを自動適用します。

## コミットメッセージの言語

コミットメッセージは**日本語**で生成します。

## プロジェクト規約の優先度

1. **CommitLint 設定** (最優先)
2. **既存コミット履歴** (第2優先)
3. **プロジェクト種別** (第3優先)
4. **Conventional Commits 標準** (フォールバック)

## 前提条件

- Git リポジトリ内で実行
- 未コミットの変更が存在すること
- ステージングされた変更は一旦リセットされます

## 注意事項

- **自動プッシュなし**: コミット後の `git push` は手動実行
- **ブランチ作成なし**: 現在のブランチでコミット
- **バックアップ推奨**: 重要な変更前には `git stash` でバックアップ

## ベストプラクティス

1. **プロジェクト規約の尊重**: 既存の設定やパターンに従う
2. **小さな変更単位**: 1つのコミットは1つの論理的変更
3. **明確なメッセージ**: 何を変更したかが明確
4. **関連性の重視**: 機能的に関連するファイルをグループ化
5. **テストの分離**: テストファイルは別コミットに

## 追加リソース

- 詳細な実装例とBashスクリプト: [reference.md](reference.md)
- Before/After の分割例: [examples.md](examples.md)

## トラブルシューティング

### コミット失敗時
- プリコミットフックの確認
- 依存関係の解決
- 個別ファイルでの再試行

### 分割が適切でない場合
- `--max-commits` オプションで調整
- 手動での `edit` モード使用
- より細かい単位での再実行
